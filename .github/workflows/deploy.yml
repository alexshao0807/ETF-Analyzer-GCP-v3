name: Deploy CloudJob to Artifact Registry (v2)

# 觸發條件：當 push 到 master 分支時執行
on:
  push:
    branches: [ "master" ]
  workflow_dispatch: # 允許手動按按鈕觸發

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }} # 讀取你在 GitHub 設定的專案 ID
  GAR_LOCATION: asia-east1                  # 你的 Registry 地區
  REPOSITORY: etf-repo                      # 你的 Registry 名稱
  IMAGE: etf-job                            # 你的 Image 名稱
  TAG: v2                                   # ★ 關鍵：固定使用 v2，對齊你的 K8s 設定

jobs:
  build-push-artifact:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # 1. 登入 Google Cloud
      - name: Google Auth
        id: auth
        uses: 'google-github-actions/auth@v1'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      # 2. 設定 Docker 認證
      - name: Docker Auth
        id: docker-auth
        uses: 'docker/login-action@v2'
        with:
          registry: ${{ env.GAR_LOCATION }}-docker.pkg.dev
          username: _json_key
          password: ${{ secrets.GCP_SA_KEY }}

      # 3. 建置並推送 Docker Image
      # 這會把你的程式碼打包成 :v2，並強制覆蓋掉雲端舊的 v2
     - name: Build and Push Docker Image
        run: |
          # 使用引號包裹路徑，處理「ETF Compare」中間的空格
          docker build -t ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE }}:${{ env.TAG }} -f "./src/CloudJob/ETF Compare/Dockerfile" ./src
          docker push ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE }}:${{ env.TAG }}